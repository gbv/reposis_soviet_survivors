!function(e){"use strict";var t='[data-search="searchEntity"]',a=function(t,n){this.options=e.extend({},a.DEFAULTS,n),this.$parent=null,this.$element=e(t),this.$inputGroup=null,this.$searchBtn=null,this.$typeBtn=null,this.$typeMenu=null,this.$feedback=null,this.selectedType="SELECT"==n.searchType.toUpperCase()?a.DEFAULTS.searchType:n.searchType,this.init()};function n(e){var t=e.indexOf("/");return-1!=t?e.substring(0,t).trim():e}function r(t){var a=t.attr("data-target");a||(a=t.attr("data-next")?t.closest(".form-group").next(t.attr("data-next")):(a=t.attr("href"))&&/#[A-Za-z]/.test(a)&&a.replace(/.*(?=#[^\s]*$)/,""));var n=a&&e(a);return n&&n.length?n.length>1?n=n.has(t):n:t.parent()}function o(t){return this.each(function(){var n=e(this),r=n.data("mcr.searchentity");r||n.data("mcr.searchentity",r=new a(this,t)),"string"==typeof t&&r[t]()})}a.VERSION="1.1.0",a.LABEL_CLEANUP=/\s[\(]?[0-9-]+[\)]?/g,a.TYPES={VIAF:{baseURI:"http://www.viaf.org/viaf/",person:{enabled:!0,url:"//www.viaf.org/viaf/AutoSuggest",data:function(e){return{query:e}},dataType:"jsonp",dataConvert:function(t){var a=[];return void 0!==t.result&&e(t.result).each(function(e,t){if("personal"===t.nametype.toLowerCase()){var n={label:t.term,value:"http://www.viaf.org/viaf/"+t.viafid};a.push(n)}}),a}},organisation:{enabled:!0,url:"http://www.viaf.org/viaf/AutoSuggest",data:function(e){return{query:e}},dataType:"jsonp",dataConvert:function(t){var a=[];return void 0!==t.result&&e(t.result).each(function(e,t){if("corporate"===t.nametype.toLowerCase()){var n={label:t.term,value:"http://www.viaf.org/viaf/"+t.viafid};a.push(n)}}),a}},both:{enabled:!0,url:"//www.viaf.org/viaf/AutoSuggest",data:function(e){return{query:e}},dataType:"jsonp",dataConvert:function(t){var a=[];return void 0!==t.result&&e(t.result).each(function(e,t){if("personal"===t.nametype.toLowerCase()){var n={label:t.term,value:"http://www.viaf.org/viaf/"+t.viafid,type:"personal"};a.push(n)}if("corporate"===t.nametype.toLowerCase()){var r={label:t.term,value:"http://www.viaf.org/viaf/"+t.viafid,type:"corporate"};a.push(r)}}),a}},topic:{enabled:!1},geographic:{enabled:!1}},GND:{baseURI:"https://d-nb.info/gnd/",person:{enabled:!0,url:"https://lobid.org/gnd/search",data:function(e){return{q:e,filter:"type:DifferentiatedPerson",format:"json:suggest",size:"30"}},dataType:"jsonp",dataConvert:function(e){var t=[];return void 0!==e&&e.length>0&&e.forEach(e=>{if("Individualisierte Person"===e.category){var a={label:e.label,value:e.id,type:"personal"};t.push(a)}}),t}},organisation:{enabled:!0,url:"https://lobid.org/gnd/search",data:function(e){return{q:e,filter:"type:CorporateBody",format:"json:suggest",size:"30"}},dataType:"jsonp",dataConvert:function(e){var t=[];return void 0!==e&&e.length>0&&e.forEach(e=>{if("Körperschaft"===e.category){var a={label:e.label,value:e.id,type:"corporate"};t.push(a)}}),t}},both:{enabled:!0,url:"https://lobid.org/gnd/search",data:function(e){return{q:e,filter:"type:DifferentiatedPerson OR type:CorporateBody",format:"json:suggest",size:"30"}},dataType:"jsonp",dataConvert:function(e){var t=[];return void 0!==e&&e.length>0&&e.forEach(e=>{if("Individualisierte Person"===e.category){var a={label:e.label,value:e.id,type:"personal"};t.push(a)}if("Körperschaft"===e.category){var n={label:e.label,value:e.id,type:"corporate"};t.push(n)}}),t}},topic:{enabled:!0,url:"https://lobid.org/gnd/search",data:function(e){return{q:e,filter:"type:SubjectHeading",format:"json:suggest",size:"30"}},dataType:"jsonp",dataConvert:function(e){var t=[];return void 0!==e&&e.length>0&&e.forEach(e=>{var a={label:e.label,value:e.id};t.push(a)}),t}},geographic:{enabled:!0,url:"https://lobid.org/gnd/search",data:function(e){return{q:e,filter:"type:PlaceOrGeographicName",format:"json:suggest",size:"30"}},dataType:"jsonp",dataConvert:function(e){var t=[];return void 0!==e&&e.length>0&&e.forEach(e=>{var a={label:e.label,value:e.id};t.push(a)}),t}}},GND_FALLBACK:{baseURI:"http://d-nb.info/gnd/",person:{enabled:!0,url:"//ws.gbv.de/suggest/gnd/",data:function(e){return{searchterm:e,type:"DifferentiatedPerson"}},dataType:"jsonp",dataConvert:function(t){var a=[];return 4==t.length&&e(t[1]).each(function(e,r){if("DifferentiatedPerson"===n(t[2][e])){var o={label:r,value:t[3][e],type:"personal"};a.push(o)}}),a}},organisation:{enabled:!0,url:"//ws.gbv.de/suggest/gnd/",data:function(e){return{searchterm:e,type:"CorporateBody"}},dataType:"jsonp",dataConvert:function(t){var a=[];return 4==t.length&&e(t[1]).each(function(e,r){if("CorporateBody"===n(t[2][e])){var o={label:r,value:t[3][e],type:"corporate"};a.push(o)}}),a}},both:{enabled:!0,url:"//ws.gbv.de/suggest/gnd/",data:function(e){return{searchterm:e,type:"DifferentiatedPerson,CorporateBody",count:"30"}},dataType:"jsonp",dataConvert:function(t){var a=[];return 4==t.length&&e(t[1]).each(function(e,r){if("DifferentiatedPerson"===n(t[2][e])){var o={label:r,value:t[3][e],type:"personal"};a.push(o)}if("CorporateBody"===n(t[2][e])){var s={label:r,value:t[3][e],type:"corporate"};a.push(s)}}),a}},topic:{enabled:!0,url:"//ws.gbv.de/suggest/gnd/",data:function(e){return{searchterm:e,type:"SubjectHeading"}},dataType:"jsonp",dataConvert:function(t){var a=[];return 4==t.length&&e(t[1]).each(function(e,r){if("SubjectHeading"===n(t[2][e])){var o={label:r,value:t[3][e]};a.push(o)}}),a}},geographic:{enabled:!0,url:"//ws.gbv.de/suggest/gnd/",data:function(e){return{searchterm:e,type:"PlaceOrGeographicName"}},dataType:"jsonp",dataConvert:function(t){var a=[];return 4==t.length&&e(t[1]).each(function(e,r){if("PlaceOrGeographicName"===n(t[2][e])){var o={label:r,value:t[3][e]};a.push(o)}}),a}}},ORCID:{baseURI:"https://orcid.org/",person:{enabled:!0,url:window.webApplicationBaseURL+"servlets/MIROrcidServlet",data:function(e){return{q:e}},dataConvert:function(e){return e}},organisation:{enabled:!1},both:{enabled:!0,url:window.webApplicationBaseURL+"servlets/MIROrcidServlet",data:function(e){return{q:e}},dataConvert:function(e){return e}},topic:{enabled:!1},geographic:{enabled:!1}}},a.DEFAULTS={buttonClass:"btn btn-secondary",feedbackClass:"feedback badge badge-primary",feedbackCleanIconClass:"feedback-clean far fa-times-circle",inputMinLength:3,searchType:"VIAF",searchResultMaxHeight:200,searchButton:"Search",searchButtonLoading:"Loading...",searchResultEmpty:"<center><b>Nothing found</b></center>"},a.prototype.init=function(){if("function"==typeof e.fn.dropdown||"function"==typeof e.fn.button){var t=this,n=this.options,o=this.$parent=e(document.createElement("div")),s=this.$inputGroup=e(document.createElement("div"));s.addClass("input-group");var i=this.$element.clone();s.append(i),this.$element.before(o),this.$element.remove(),this.$element=i;var l=e(document.createElement("div"));l.addClass("input-group-btn input-group-append");var d=this.$searchBtn=e(document.createElement("button"));if(d.addClass(n.buttonClass),d.attr("data-loading-text",n.searchButtonLoading),d.html(n.searchButton),d.on("click",function(e){e.preventDefault(),t.search(e)}),l.append(d),s.append(l),o.append(s),"SELECT"==n.searchType.toUpperCase()){var p=void 0!==e(n.searchOutput,r(i))[0]?e(n.searchOutput,r(i)).val():"",u=void 0!==e(n.searchOutputType,r(i))[0]?e(n.searchOutputType,r(i)).val():"";p.length>0&&(this.selectedType=u.toUpperCase());var c=this.$typeBtn=e(document.createElement("button"));c.addClass(n.buttonClass).addClass("dropdown-toggle"),c.attr("data-toggle","dropdown"),c.html('<span class="caret"></span><span class="sr-only">Toggle Dropdown</span>'),l.append(c);var h=this.$typeMenu=e(document.createElement("ul"));for(var f in h.addClass("dropdown-menu dropdown-menu-right"),h.attr("role","menu"),a.TYPES)if(!1!==a.TYPES[f][n.searchEntityType].enabled&&!f.includes("_FALLBACK")){void 0!=a.TYPES[this.selectedType]&&0==a.TYPES[this.selectedType][n.searchEntityType].enabled&&(this.selectedType=f);var v=e(document.createElement("li"));f.toUpperCase()===this.selectedType.toUpperCase()&&v.addClass("active");var g=e(document.createElement("a"));g.addClass("dropdown-item"),g.attr("href","#"),g.data("search-type",f),g.text(f),g.on("click",function(a){a.preventDefault(),t.selectedType=e(this).data("search-type"),e(".active",e(this).parents("ul")).toggleClass("active"),e(this).parent().toggleClass("active")}),v.append(g),h.append(v)}l.append(h),c.dropdown()}this.updateOutput()}else console.error('Couldn\'t initalize SearchEntity because of missing Bootstrap "dropdown" and "button" plugin!')},a.prototype.search=function(e){var t=this.$parent,n=this.options,r=t.find(".dropdown-menu").hasClass("show");if(this.clearAll(),!r){!t.hasClass("dropdown")&&t.addClass("dropdown");var o=this.$element.val();if(o.length<n.inputMinLength)return;var s=null,i=null;for(var l in a.TYPES)if(this.selectedType.toUpperCase()==l.toUpperCase()){s=a.TYPES[l][n.searchEntityType],a.TYPES.hasOwnProperty(l+"_FALLBACK")&&(i=a.TYPES[l+"_FALLBACK"][n.searchEntityType]);break}let e=this.$searchBtn.text();this.$searchBtn.text(" "+this.$searchBtn.attr("data-loading-text"));let r=jQuery('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span><span class="sr-only">'+this.$searchBtn.attr("data-loading-text")+"</span>");this.$searchBtn.prepend(r);let p=this;if(null!=s){var d=(t,n,l,u)=>{a.loadData(t,n,l,t=>{void 0!==t?p.showResult(a.sortData(o,"function"==typeof s.dataConvert?s.dataConvert(t):t)):p.showResult(),r.detach(),p.$searchBtn.text(e)},()=>{u||null==i?(console.error("SearchEntity.prototype.search: LoadData failed for type "+this.selectedType.toUpperCase()),p.showResult(),r.detach(),p.$searchBtn.text(e)):(console.log("SearchEntity.prototype.search: Failed to loadData for type: "+this.selectedType.toUpperCase()+". Set "+this.selectedType.toUpperCase()+"_FALLBACK as type."),d((s=i).url,s.dataType,s.data(o),!0))})};d(s.url,s.dataType,s.data(o),!1)}else console.error('Search type "'+this.selectedType.toUpperCase()+'" is unsupported!'),r.detach(),this.$searchBtn.text(e)}return!1},a.prototype.showResult=function(t){var a=this,n=this.$parent,r=this.options,o=e(document.createElement("div"));o.addClass("dropdown");var s=e(document.createElement("ul"));if(s.attr("role","menu"),s.addClass("dropdown-menu"),o.append(s),t&&t.length>0)e(t).each(function(t,n){var r=e(document.createElement("li")),o=e(document.createElement("a"));o.addClass("dropdown-item"),o.attr("href","#"),o.attr("data-type",n.type),o.text(n.label),o.on("click",function(e){e.preventDefault(),a.updateOutput(n),a.clearAll()}),r.append(o),s.append(r)});else{var i=e(document.createElement("li"));i.html(r.searchResultEmpty),s.append(i)}n.append(o),s.css({height:"auto",maxHeight:r.searchResultMaxHeight,width:"100%",overflow:"auto",overflowX:"hidden"}),s.addClass("show"),this.$element.data(e.extend({},{searchResultContainer:o},r))},a.prototype.updateOutput=function(t){var n=this,o=this.options,s=void 0!==e(o.searchOutput,r(this.$element))[0]?e(o.searchOutput,r(this.$element)).first():this.$element,i=void 0!==e(o.searchOutputType,r(this.$element))[0]?e(o.searchOutputType,r(this.$element)).first():this.$element,l=void 0!==e(o.searchOutputNameType,r(this.$element))[0]?e(o.searchOutputNameType,r(this.$element)).first():this.$element,d=[];if(t){this.$element!=s&&t.label&&this.$element.val(t.label.replace(a.LABEL_CLEANUP,"").split("|")[0].trim());var p=function(e){for(var t in a.TYPES)if(-1!=e.indexOf(a.TYPES[t].baseURI)&&!t.includes("_FALLBACK"))return t;return""}(t.value);if(t.type){l.val(t.type.toLowerCase());var u=e(s).closest('[class="personExtended_box"]');if(u&&u.length>0){var c=0,h=null,f=null,v=!0;for(d=(d=e(u).find('input[name*="/mods:nameIdentifier"]')).toArray();c<d.length&&d[c].value&&d[c].type&&"hidden"!==d[c].type;)c++;if((h=(f=e(u).find('select[name*="/mods:nameIdentifier"]')).map(function(){return this.value}).get()).includes(p.toLowerCase())){let t=null,a=null;for(var g=0;g<h.length&&null===t;g++)if(h[g]===p.toLowerCase()){var y=e(f[g]).closest("div.form-group").find('input[name*="/mods:nameIdentifier"]');y.val()&&(t=g),a=g}null===t&&(t=a),s[0]=y[0],i[0]=f[t]}else{s[0]=d[c];let t=e('[name="'+d[c].name+'/@type"]');i[0]=t[0]}}}s.val(function(e){for(var t in a.TYPES){var n=e.indexOf(a.TYPES[t].baseURI);if(-1!=n)return e.substr(n+a.TYPES[t].baseURI.length)}return""}(t.value)),""!=p&&i.val(p.toLowerCase()),d.forEach((e,t)=>{e.value||(v=!1)})}if(s!=this.$element&&s.val().length>0){var m=i.val(),b=e(document.createElement("a"));b.attr("href",function(e,t){var n=a.TYPES[e.toUpperCase()];if(void 0!=n)return n.baseURI+t;return""}(i.val(),s.val())),b.attr("target","_blank"),b.attr("class","mcr-badge--origin"),b.css({textDecoration:"none"}),null!=m&&void 0!=a.TYPES[m.toUpperCase()]||(b.attr("onclick","return false;"),b.css({cursor:"default"}));var C=e(document.createElement("span"));C.addClass(o.feedbackClass),C.html(null!=m?m.toUpperCase():"N/A");var w=e(document.createElement("a"));w.attr("href","#"),w.html('<i class="'+o.feedbackCleanIconClass+'"></i>'),w.on("click",function(e){e.preventDefault(),n.updateOutput({value:""})}),C.append(w),b.append(C),this.$feedback&&this.$feedback.remove(),this.$feedback=b,this.$element.after(b),b.css({marginLeft:-(b.width()+10)}),this.$element.css({paddingRight:b.width()+20})}else this.$feedback&&this.$feedback.remove(),this.$element.css({paddingRight:20});if(t&&t.type&&v){e(d[d.length-1]).closest('div[class="form-group row"]').find('button[name^="_xed_submit_insert"]').click()}},a.prototype.clearAll=function(n){n&&3===n.which||e(t).each(function(){var t=e(this),n="object"==typeof this.options?this.options:e.extend({},a.DEFAULTS,t.data()),o=void 0===this.$parent?r(t):this.$parent;e(".dropdown-toggle",o).each(function(t){e(this).dropdown()});var s=e(n.searchResultContainer);void 0!==s[0]&&(s.parent().removeClass("open"),s.remove(),t.removeData("searchResultContainer"))})},a.loadData=function(t,a,n,r,o){e.ajax({url:t,timeout:5e3,dataType:a,data:n,success:function(e){r(e)},error:function(){o()}})},a.sortData=function(e,t){function n(e,t,a){var n=e.length,r=t.length;if(Math.abs(n-r)>(a||32))return a||32;if(0===n)return r;if(0===r)return n;for(var o,s,i,l,d=[],p=0;p<64;p++)d[p]=[p],d[p].length=64;for(p=0;p<64;p++)d[0][p]=p;for(p=1;p<=n;++p){o=e[p-1];for(var u=1;u<=r;++u){if(p===u&&d[p][u]>4)return n;s=o===t[u-1]?0:1,i=d[p-1][u]+1,(l=d[p][u-1]+1)<i&&(i=l),(l=d[p-1][u-1]+s)<i&&(i=l),d[p][u]=i}}return d[n][r]}return t.sort(function(t,r){return n(e,t.label.replace(a.LABEL_CLEANUP,""))-n(e,r.label.replace(a.LABEL_CLEANUP,""))})};var s=e.fn.SearchEntity;e.fn.searchEntity=o,e.fn.searchEntity.Constructor=a,e.fn.searchEntity.noConflict=function(){return e.fn.SearchEntity=s,this},e(window).on("load",function(){e(t).each(function(){var t=e(this),a=t.data();o.call(t,a)})}),e(document).on("click.mcr.searchentity.data-api",a.prototype.clearAll)}(jQuery);
//# sourceMappingURL=jquery.search-entity.min.js.map